{% extends "base.html" %}
{% block title %}Production Server Assets{% endblock %}

{% block content %}

<!-- ================= COUNTERS ================= -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <small class="text-muted">Total Servers</small>
        <h4 class="mb-0">{{ counters.total }}</h4>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <small class="text-muted">Production</small>
        <h4 class="mb-0">{{ counters.prod }}</h4>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <small class="text-muted">Disaster Recovery</small>
        <h4 class="mb-0">{{ counters.dr }}</h4>
      </div>
    </div>
  </div>
</div>

<!-- ================= FILTER ================= -->
<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input name="q"
           value="{{ request.args.get('q','') }}"
           class="form-control form-control-sm"
           placeholder="Search hostname">
  </div>
  <div class="col-md-2">
    <select name="segment" class="form-select form-select-sm">
      <option value="">All Segments</option>
      {% for seg in counters.by_segment.keys() %}
      <option value="{{ seg }}" {% if request.args.get('segment') == seg %}selected{% endif %}>
        {{ seg }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <select name="env" class="form-select form-select-sm">
      <option value="">All Env</option>
      <option value="Production" {% if request.args.get('env') == 'Production' %}selected{% endif %}>
        Production
      </option>
      <option value="Disaster Recovery" {% if request.args.get('env') == 'Disaster Recovery' %}selected{% endif %}>
        Disaster Recovery
      </option>
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-sm btn-dark w-100">üîç Filter</button>
  </div>

  {% if current_user.role in ["admin", "operator"] %}
  <div class="col-md-3 text-end">
    <a href="{{ url_for('assets.server_create') }}" class="btn btn-sm btn-dark">‚ûï Register Server</a>
  </div>
  {% endif %}
</form>

<!-- ================= GROUPED TABLE ================= -->
{% for segment, servers in grouped.items() %}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold">
        {{ segment }} ({{ servers|length }}) ‚Äî
        CPU: {{ segment_totals[segment].cpu }} cores,
        RAM: {{ segment_totals[segment].ram_tb }} TB,
        Storage: {{ segment_totals[segment].storage_tb }} TB
    </div>


  <div class="card-body p-0">
    <table class="table table-sm table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Hostname</th>
          <th>IP Address</th>
          <th>Environment</th>
          <th>Operating Server</th>
          <th>CPU Core</th>
          <th>RAM Size (GB)</th>
          <th>Storage Size (GB)</th>
          <th>PIC</th>
          {% if current_user.role in ["admin", "operator"] %}
          <th class="text-end">Action</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for s in servers %}
        <tr>
            <td class="fw-medium">{{ s.hostname }}</td>
            <td>{{ s.ip_address }}</td>
            <td>{{ s.environment }}</td>
            <td>{{ s.os }}</td>
            <td>{{ s.cpu }} cores</td>
            <td>{{ s.ram }} GB</td>
            <td>{{ s.storage }} GB</td>
            <td>{{ s.owner }}</td>

          {% if current_user.role in ["admin", "operator"] %}
          <td class="text-end">
            <a href="{{ url_for('assets.server_edit', id=s.id) }}" class="btn btn-sm btn-outline-primary me-1">‚úèÔ∏è</a>
            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ s.id }}">üóë</button>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ================= DELETE MODALS ================= -->
{% for s in servers %}
<div class="modal fade" id="deleteModal{{ s.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title text-danger">Confirm Delete</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-2">Delete server <strong>{{ s.hostname }}</strong>?</p>
        <small class="text-muted">This action cannot be undone.</small>
      </div>
      <div class="modal-footer justify-content-center">
        <form method="post" action="{{ url_for('assets.server_delete', id=s.id) }}">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endfor %}

{% endblock %}
